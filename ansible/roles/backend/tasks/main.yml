---
- name: Capture current backend container image IDs
  block:
    - name: Get running fastapi image ID (if any)
      ansible.builtin.command:
        cmd: docker inspect --format='{{"{{.Image}}"}}' fastapi
      register: fastapi_current_image
      failed_when: false
      changed_when: false

- name: Pull backend images to ensure freshest tags are present
  block:
    - name: Pull fastapi image
      ansible.builtin.shell: |
        #!/bin/bash
        set -e
        COMPOSE_FILE="/home/{{ ansible_user }}/nuspace/infra/prod.docker-compose.yml"
        {{ compose_cmd }} -f "$COMPOSE_FILE" pull fastapi
      args:
        executable: /bin/bash

- name: Capture freshly pulled backend image IDs
  block:
    - name: Get latest fastapi image ID
      ansible.builtin.command:
        cmd: docker image inspect kamikadze24/fastapi:latest --format='{{"{{.Id}}"}}'
      register: fastapi_latest_image
      failed_when: fastapi_latest_image.rc != 0
      changed_when: false

    - name: Determine backend rollout requirement
      ansible.builtin.set_fact:
        fastapi_image_changed: >-
          {{
            fastapi_current_image.rc != 0 or
            fastapi_current_image.stdout.strip() != fastapi_latest_image.stdout.strip()
          }}
        backend_rollout_needed: >-
          {{
            (backend_changed | default(false)) | bool
            or (container_analysis is defined and 'fastapi' in container_analysis.stdout)
            or fastapi_image_changed
          }}

- name: Ensure postgres is up before migrations
  ansible.builtin.shell: |
    #!/bin/bash
    set -e
    COMPOSE_FILE="/home/{{ ansible_user }}/nuspace/infra/prod.docker-compose.yml"
    {{ compose_cmd }} -f "$COMPOSE_FILE" up -d postgres
    for i in {1..30}; do
      if {{ compose_cmd }} -f "$COMPOSE_FILE" exec -T postgres sh -lc 'pg_isready -h 127.0.0.1 -p 5432 >/dev/null 2>&1'; then
        echo "Postgres is ready"
        exit 0
      fi
      sleep 2
    done
    echo "Postgres not ready after timeout" >&2
    exit 1
  args:
    executable: /bin/bash
  when: backend_rollout_needed | default(false) | bool
  register: postgres_ready

- name: Run DB migrations (alembic upgrade head)
  ansible.builtin.shell: |
    #!/bin/bash
    set -e
    COMPOSE_FILE="/home/{{ ansible_user }}/nuspace/infra/prod.docker-compose.yml"
    {{ compose_cmd }} -f "$COMPOSE_FILE" run --rm migrate
  args:
    executable: /bin/bash
  when: backend_rollout_needed | default(false) | bool
  register: migrate_result

- name: Recreate backend services (fastapi) when needed
  ansible.builtin.command: >
    {{ compose_cmd }} -f /home/{{ ansible_user }}/nuspace/infra/prod.docker-compose.yml
    up --no-deps -d fastapi
  when: backend_rollout_needed | default(false) | bool
  register: backend_up
